name: Build

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        ort-version: ["1.23.0"]
    env:
      ONNXRUNTIME_VERSION: ${{ matrix.ort-version }}
      ONNXRUNTIME_GENAI_VERSION: "0.11.0"
    steps:
    - uses: actions/checkout@v6

    - uses: actions/setup-go@v6
      with:
        go-version-file: 'go.mod'

    - name: Install staticcheck
      run: go install honnef.co/go/tools/cmd/staticcheck@2025.1.1

    - name: Setup go.work
      run: make setup-workspace

    - name: Build
      run: go build -v github.com/benedoc-inc/onnxer/...

    - name: Lint
      run: make lint

    - name: Cache ONNX Runtime
      id: cache-onnxruntime
      uses: actions/cache@v4
      with:
        path: lib/libonnxruntime.so*
        key: onnxruntime-linux-x64-${{ matrix.ort-version }}

    - name: Download ONNX Runtime
      if: steps.cache-onnxruntime.outputs.cache-hit != 'true'
      run: |
        ./download.sh ${{ env.ONNXRUNTIME_VERSION }}
        mkdir -p lib
        cp libs/${{ env.ONNXRUNTIME_VERSION }}/lib/libonnxruntime.so* lib/
        rm -rf libs/${{ env.ONNXRUNTIME_VERSION }}

    - name: Cache ONNX Runtime GenAI
      id: cache-genai
      uses: actions/cache@v4
      with:
        path: lib/libonnxruntime-genai.so
        key: genai-linux-x64-${{ env.ONNXRUNTIME_GENAI_VERSION }}

    - name: Download ONNX Runtime GenAI
      if: steps.cache-genai.outputs.cache-hit != 'true'
      run: |
        ./download_genai.sh ${{ env.ONNXRUNTIME_GENAI_VERSION }}
        mkdir -p lib
        cp libs/genai/${{ env.ONNXRUNTIME_GENAI_VERSION }}/lib/libonnxruntime-genai.so lib/
        rm -rf libs/genai/${{ env.ONNXRUNTIME_GENAI_VERSION }}

    - name: Test with coverage
      run: go test -v -coverprofile=coverage.out ./...
      env:
        LD_LIBRARY_PATH: ${{ github.workspace }}/lib

    - name: Check coverage
      run: |
        total=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
        echo "Total coverage: ${total}%"
        echo "## Test Coverage: ${total}%" >> $GITHUB_STEP_SUMMARY

    - name: Build examples
      run: |
        for dir in examples/*/; do
          if [ -f "$dir/go.mod" ]; then
            echo "Building $dir..."
            (cd "$dir" && go build ./...)
          fi
        done
